<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ABACSTORE | Login / Sign-Up</title>
  
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  
  <!-- Google Font: Tektur -->
  <link href="https://fonts.googleapis.com/css2?family=Tektur:wght@400;700&display=swap" rel="stylesheet" />
  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  
  <style>
    body {
      font-family: 'Tektur', sans-serif;
      background-color: #f8f9fa;
    }
    .auth-container {
      max-width: 500px;
      margin: 50px auto;
    }
    .tab-content {
      background: #fff;
      padding: 30px;
      border: 1px solid #ddd;
      border-top: none;
      border-radius: 0 0 5px 5px;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">ABACSTORE</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <!-- Optional: additional nav links -->
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <!-- Additional nav links can go here -->
        </ul>
      </div>
    </div>
  </nav>
  
  <!-- Authentication Container -->
  <div class="auth-container">
    <ul class="nav nav-tabs" id="authTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="login-tab" data-bs-toggle="tab" data-bs-target="#login" type="button" role="tab">Login</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="signup-tab" data-bs-toggle="tab" data-bs-target="#signup" type="button" role="tab">Sign Up</button>
      </li>
    </ul>
    <div class="tab-content" id="authTabContent">
      <!-- Login Form -->
      <div class="tab-pane fade show active" id="login" role="tabpanel">
        <form id="loginForm">
          <div class="mb-3">
            <label for="loginEmail" class="form-label">Email address</label>
            <input type="email" class="form-control" id="loginEmail" placeholder="Enter email" required>
          </div>
          <div class="mb-3">
            <label for="loginPassword" class="form-label">Password</label>
            <input type="password" class="form-control" id="loginPassword" placeholder="Password" required>
          </div>
          <!-- Placeholder for MFA token input if required -->
          <button type="submit" class="btn btn-primary w-100">Login</button>
          <p class="mt-3 text-center"><a href="password-reset.html">Forgot Password?</a></p>
          <p id="loginResponse" class="text-center mt-2"></p>
        </form>
      </div>
      
      <!-- Sign-Up Form -->
      <div class="tab-pane fade" id="signup" role="tabpanel">
        <form id="signupForm">
          <div class="mb-3">
            <label for="signupEmail" class="form-label">Email address</label>
            <input type="email" class="form-control" id="signupEmail" placeholder="Enter email" required>
          </div>
          <div class="mb-3">
            <label for="signupPassword" class="form-label">Password</label>
            <input type="password" class="form-control" id="signupPassword" placeholder="Password" required>
          </div>
          <!-- Account Type Selection -->
          <div class="mb-3">
            <label for="accountType" class="form-label">Account Type</label>
            <select id="accountType" class="form-select" required>
              <option value="user" selected>User</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <!-- Admin Code (visible only if Admin is selected) -->
          <div class="mb-3" id="adminCodeContainer" style="display: none;">
            <label for="adminCode" class="form-label">Admin Code</label>
            <input type="text" id="adminCode" class="form-control" placeholder="Enter admin code">
          </div>
          <button type="submit" class="btn btn-success w-100">Sign Up</button>
          <p id="signupResponse" class="text-center mt-2"></p>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Supabase & JS Code -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const SUPABASE_URL = 'https://jgnabxpbmhjitfsyeqms.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpnbmFieHBibWhqaXRmc3llcW1zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI5NjM1OTQsImV4cCI6MjA1ODUzOTU5NH0.c0j_548Qmb5TKKvbXUWddgqQhxyzG_Fi_wzm-c8_RaI';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Toggle admin code input on account type change
    const accountTypeEl = document.getElementById('accountType');
    const adminCodeContainer = document.getElementById('adminCodeContainer');
    accountTypeEl.addEventListener('change', () => {
      adminCodeContainer.style.display = accountTypeEl.value === 'admin' ? 'block' : 'none';
    });

    // Handle login form submission with redirection based on role
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) {
        document.getElementById('loginResponse').textContent = error.message;
      } else {
        document.getElementById('loginResponse').textContent = 'Login successful!';
        // Fetch latest session info which includes user_metadata
        const { data: { session } } = await supabase.auth.getSession();
        const role = session?.user?.user_metadata?.role || 'user';
        // Redirect based on role
        setTimeout(() => {
          if (role === 'admin') {
            window.location.href = 'admin-user-management.html';
          } else {
            window.location.href = 'dashboard.html';
          }
        }, 1000);
      }
    });

    // Handle sign-up form submission
    document.getElementById('signupForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('signupEmail').value;
      const password = document.getElementById('signupPassword').value;
      const accountType = document.getElementById('accountType').value;
      const adminCode = document.getElementById('adminCode').value.trim();
      
      // If admin account is selected, verify the admin code
      if (accountType === 'admin') {
        const validAdminCode = 'SECRET123'; // Replace with secure logic in production
        if (adminCode !== validAdminCode) {
          document.getElementById('signupResponse').textContent = 'Invalid admin code.';
          return;
        }
      }
      
      // Sign up with additional user metadata for role
      const { data, error } = await supabase.auth.signUp(
        { email, password },
        { data: { role: accountType } }
      );
      
      if (error) {
        document.getElementById('signupResponse').textContent = error.message;
      } else {
        document.getElementById('signupResponse').textContent = 'Sign-up successful! Check your email for confirmation.';
      }
    });
  </script>
  
  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
